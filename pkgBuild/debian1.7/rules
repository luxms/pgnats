#!/usr/bin/make -f
export DH_VERBOSE = 1

GPG_OPTIONS := --batch --pinentry-mode loopback --passphrase-file GPG_PASS --default-key=08C82543B30BE336

PGCONFIG_pgsql15-nats := /usr/lib/postgresql/15/bin/pg_config
PGCONFIG_pgpro15-nats := /opt/pgpro/std-15/bin/pg_config
PGCONFIG_pgpro15ent-nats := /opt/pgpro/ent-15/bin/pg_config
PGCONFIG_pgpro17-nats := /opt/pgpro/std-17/bin/pg_config
PGCONFIG_pgpro17ent-nats := /opt/pgpro/ent-17/bin/pg_config

PKG_LIST := $(foreach pkg,$(shell dh_listpackages), $(shell if [ -f $(PGCONFIG_$(pkg)) ] ; then echo $(pkg); fi))

define \n


endef

override_dh_strip:
	dh_strip
	$(if $(filter true,$(CI)),\
		find debian/ -type f -name pgnats.so > elf_files.list;\
	  if [ -f elf_files.list ]; then bsign -s -E --pgoptions="$(GPG_OPTIONS)" -f elf_files.list ; bsign -c -E -f elf_files.list; fi \
	,)

override_dh_auto_install:
	$(foreach pkg,$(PKG_LIST), \
	    PG_VER=`echo 'pgsql15-nats' | grep -o '[0-9]\+'` \
	    && echo $PG_VER \
		&& /root/.cargo/bin/cargo pgrx init --pg$PG_VER $(PGCONFIG_$(pkg)) \
		&& /root/.cargo/bin/cargo pgrx package --features xid8 --pg-config $(PGCONFIG_$(pkg)) \
		&& $(if $(filter true,$(CI)),./trivy-scan.sh src $(pkg),:) \
		&& mv target/release/pgnats-pg$PG_VER debian/$(pkg) \
		${\n} \
	)


%:
	dh $@ --srcdirectory=src $(foreach pkg,$(PKG_LIST), -p$(pkg) )
